---
id: PR-04
title: Flow integration: wizard add/update/remove-step powered by distribution client
date: 2026-02-05
repo: greentic-flow (+ greentic-distribution-client)
track: flow-wizard
depends_on: [PR-03]
---

# PR-04: greentic-flow add/update/remove-step uses distribution client + component wizard ops

## Goal
Make `greentic-flow` the canonical place that:
- resolves component WASM artifacts via `greentic-distribution-client`
- calls component wizard operations (describe/qa-spec/apply-answers) on the resolved WASM
- updates a flow file by adding/updating/removing a component step and associated configuration/secrets hints

This ensures greentic-component wizard does not hardcode where to fetch artifacts from.

## CLI
Extend greentic-flow:

- `greentic-flow add-step <component_id> --flow <flow_file> [--mode default|setup] [--answers <answers>.json]`
- `greentic-flow update-step <component_id> --flow <flow_file> [--mode upgrade] [--answers <answers>.json]`
- `greentic-flow remove-step <component_id> --flow <flow_file> [--mode remove] [--answers <answers>.json]`

Defaults:
- add-step mode default
- update-step mode upgrade
- remove-step mode remove

## Implementation outline
1) Resolve WASM:
- use greentic-distribution-client to locate the correct wasm for the component id and ABI version (0.6.0 for now)
- support local override if already present (existing flow behavior)

2) Call component ops:
- call `describe()` to obtain component descriptor
- call `qa-spec(mode)` to obtain QA spec for the chosen mode
- collect answers:
  - if --answers: read JSON and convert to canonical CBOR
  - else: invoke greentic-qa interactive (or reuse existing prompt runner) and convert result to CBOR
- call `apply-answers(mode, current_config, answers)` and parse response

3) Apply to flow:
- add/update/remove node
- store generated config (or config patch) in the flow’s node config section
- store required secrets list / external bindings hints in a designated flow metadata section (minimal, additive, backwards compatible)

## Tests
- Add fixtures:
  - a small flow file
  - a mock component wasm (or stub runner) to simulate describe/qa/apply
- Test add-step modifies the flow deterministically.
- Test update/remove behavior.

## Acceptance criteria
- greentic-flow can add/update/remove a component step and generate config using wizard ops.
- Artifact resolution is handled by greentic-distribution-client.
- No need to run greentic-component wizard to fetch artifacts.

## Decisions / answers (2026-02-10)
1) ABI version source of truth
- Prefer component metadata from downloaded artifact (or from describe output if it includes ABI).
- Optional CLI override: `--abi-version` on add-step/update-step for cases where the component can’t report it or for local/dev builds.
- Default: if neither is available, fail with a clear error (do not assume 0.6.0).
- Rationale: hardcoding 0.6.0 makes upgrades painful and blocks multi-ABI coexistence.

2) Flow metadata section format + location
- Define now as additive, namespaced metadata inside the flow file (or sidecar), with a small schema.
- Recommended structure (conceptual):
  - `flow.meta.greentic` (or `flow.metadata.greentic`) containing:
    - `components`: map of `node_id` → `{ component_id, abi_version, digest, exported_ops_seen, added_at }`
    - `secrets_hints`: map of `node_id` → `[ { key, kind, optional, description } ]`
    - `bindings_hints`: map of `node_id` → `[ { name, type, description } ]`
- Properties:
  - Additive, namespaced, deterministic ordering on serialization.
  - Same structure for YAML/JSON and canonical CBOR.

3) apply-answers return shape + update-step behavior
- apply-answers returns full config object (patch mode can be added later).
- add-step: replace config (node is new).
- update-step: replace-by-default for determinism; consider `--merge` later if needed.
- Components can carry forward old settings internally if desired.

4) remove-step metadata cleanup
- Default: remove node and associated greentic metadata entries; no tombstones.
- Optional future flag: `--keep-metadata` if audit requirements arise.

5) Distribution resolve fallback behavior
- Default: hard error with actionable guidance.
- Optional flags:
  - `--local-wasm <path>`
  - `--component oci://…` or `--component file://…` (if supported)
  - `--interactive` only prompts when explicitly set (no CI hangs).
