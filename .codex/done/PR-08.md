# PR-08 — greentic-flow: Fixture resolver + mocked/no-network E2E harness + CI

Repo: `greentic-flow` (plus small test-only helpers)

## Goal
Provide a deterministic, no-network test harness so CI can validate:
- add-step/update-step/remove-step (PR-04)
- contract persistence + SchemaIR validation + flow doctor (PR-06)
- flow wizard + answers workflow + i18n (PR-07)

This PR adds a `fixture://` resolver implementation and test fixtures that simulate distribution + component wizard ops without network access.

## Scope
### In-scope
- Define resolver abstraction (if not already): `ComponentResolver` trait
- Implement:
  - `fixture://<path>` resolver returning:
    - wasm bytes OR a mock runner payload set
    - metadata: digest, component_id, abi_version
- Add fixtures:
  - registry layout describing components, their describe payloads, QA specs, and apply-answers outputs
- Add E2E tests that:
  - run greentic-flow commands against fixture resolver
  - confirm deterministic flow output (byte-for-byte or canonical re-encode match)
- Add CI workflow job running these tests with `--offline`.

### Out-of-scope
- Real distribution search/list UX
- Performance optimizations

## Fixture format (recommended)
Directory:
- `tests/fixtures/registry/`
  - `index.json` (maps component_id to entry)
  - `components/<component_id>/`
    - `component.wasm` (optional; can omit if using mock runner)
    - `describe.cbor`
    - `qa_default.cbor`
    - `qa_setup.cbor`
    - `qa_upgrade.cbor`
    - `qa_remove.cbor`
    - `apply_default_config.cbor` (output of apply-answers)
    - `apply_setup_config.cbor`
    - ...
    - `i18n_keys.json` (optional; or embedded in describe/qa)

Two modes:
1) WASM-backed: includes wasm; greentic-flow runs wasmtime and calls exports.
2) Mock-backed: no wasm; fixture runner returns pre-baked outputs (faster, simpler for CI).

This PR should support **mock-backed** first; WASM-backed can be added later.

## Implementation tasks
1) **Resolver trait**
   - Introduce `trait ComponentResolver { fn resolve(&self, req: ResolveReq) -> Result<ResolvedComponent> }`
   - Existing distribution resolver becomes an impl.
   - Add fixture resolver impl.

2) **Mock component runner**
   - Add `WizardOpsRunner` abstraction (if not already):
     - `describe()`, `qa_spec(mode)`, `apply_answers(mode, current_config, answers)`
   - Provide fixture runner returning bytes from disk.

3) **Golden flow fixtures**
   - Add `tests/fixtures/flows/`:
     - `base.flow.json` (or ygtc)
     - `expected_add.flow.json`
     - `expected_update.flow.json`
     - `expected_remove.flow.json`
   - Canonicalization approach:
     - decode → canonical encode → compare, to avoid ordering flakes.

4) **E2E tests**
   - Add tests that run the command handlers directly (preferred) to avoid spawning subprocesses.
   - Validate:
     - metadata includes hashes
     - config validated
     - secrets/bindings hints stored
     - results deterministic

5) **CI**
   - Add workflow job:
     - `cargo test -p greentic-flow`
     - ensure no network calls (set env to disable or run in offline mode)
   - Optionally upload generated flow outputs as artifacts for debugging.

## Acceptance criteria
- `fixture://` resolver works and is used in tests.
- Tests cover add/update/remove + doctor + wizard workflow in mocked mode.
- CI passes with no network access.
- Deterministic outputs validated.

## Decisions / answers (2026-02-11)
1) Fixture directory layout
- Use an explicit index + per-component folder files:
  - `tests/fixtures/registry/index.json` (maps component_id → relative paths + available modes)
  - `tests/fixtures/registry/components/<component_id>/describe.cbor`
  - `tests/fixtures/registry/components/<component_id>/qa_<mode>.cbor`
  - `tests/fixtures/registry/components/<component_id>/apply_<mode>_config.cbor`
  - optional `i18n_keys.json`

2) Mock-backed only or also wasm-backed now?
- Mock-backed only in PR-08. WASM-backed can follow later (CI determinism first).

3) Spawn CLI or call handlers directly?
- Call handlers directly for tests (faster, deterministic, fewer platform quirks). Add a thin CLI smoke test later if needed.
