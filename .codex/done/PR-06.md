# PR-06 — greentic-flow: Persist contracts + SchemaIR validation + flow doctor (0.6.0)

Repo: `greentic-flow`

## Goal
Make `greentic-flow` fully contract-driven for component@0.6.0 by:
- Treating `describe()` as the authoritative contract snapshot (MCP-like).
- Persisting contract identifiers (describe_hash + schema_hash) in flow metadata for each node.
- Validating node config (and optional sample inputs) against inline SchemaIR from `describe()`.
- Introducing `greentic-flow doctor` to validate flows offline (fixture/no-network compatible).

This PR focuses on correctness and deterministic behavior. UX improvements and i18n come in PR-07.

## Scope
### In-scope
- Extend `flow.meta.greentic` with contract tracking:
  - `describe_hash`
  - `operation_id`
  - `schema_hash`
  - `component_version`, `world` (if present in describe payload)
  - `resolved_digest` (if available from resolver)
- Add SchemaIR validator (strict by default):
  - validate config CBOR against `describe.config_schema`
  - validate (optional) node “input examples” against the op input schema
- Add `greentic-flow doctor --flow <file> [--offline]`:
  - validates metadata presence, hashes, config schema conformity
  - deterministic diagnostics ordering + stable exit codes
- Add deterministic serialization rules for metadata updates (no unrelated churn).

### Out-of-scope
- Multi-step flow wizard UX (PR-07)
- Full greentic-i18n rendering (PR-07)
- Fixture resolver + no-network CI (PR-08)
- Distribution fallback policy tweaks beyond what PR-04 already introduced

## Contract model
### Describe snapshot hashing
Persist both:
- `describe_hash`: sha256 over canonical CBOR encoding of the *typed* Describe payload.
- `schema_hash`: per-node/per-op hash as provided by `describe.operations[*].schema_hash`, verified by recomputing using the typed SchemaIR:
  - sha256(canonical_cbor({input, output, config}))

Rules:
- Hashing is performed on typed values (decode → canonical encode), not raw bytes.
- Canonical CBOR encoding must be used everywhere (deterministic).

### Operation selection
- Node metadata MUST include `operation_id`.
- Default operation is `"run"` if present, otherwise error (caller must pass `--op`).

## Implementation tasks
1) **Metadata structs**
   - Update flow meta model (e.g., `flow_meta.rs`) with:
     - `ComponentTracking { component_id, abi_version, resolved_digest?, describe_hash, operation_id, schema_hash, component_version?, world?, added_at, updated_at }`
   - Ensure `BTreeMap` ordering for deterministic encode/serialize.

2) **Contract capture during add-step/update-step**
   - After resolving component WASM and calling `describe()`:
     - decode typed describe
     - compute `describe_hash`
     - choose op (default run)
     - recompute schema hash and compare to op.schema_hash (fail on mismatch)
     - store all fields in `flow.meta.greentic.components[node_id]`

3) **SchemaIR validation**
   - Implement `validate_value_against_schema(schema: &SchemaIr, value: &ciborium::value::Value) -> Vec<Diagnostic>`
   - Strict rules:
     - required fields enforced
     - types enforced
     - numeric bounds, string regex/length, array bounds enforced if present
     - additionalProperties behavior enforced for objects
   - Validate:
     - config returned by apply-answers vs config_schema (always)
     - optional: input examples vs input schema (only if examples exist)

4) **greentic-flow doctor**
   - New CLI:
     - `greentic-flow doctor --flow <file> [--offline] [--format human|json]`
   - Validations:
     - every component node has tracking metadata
     - schema_hash and describe_hash present
     - node config conforms to config_schema
     - (optional online) re-resolve and compare describe_hash to detect contract drift:
       - default: offline (no network) unless `--online` explicitly set
   - Deterministic diagnostics:
     - stable ordering by (node_id, severity, code)

5) **Diagnostics types**
   - Add a simple `Diagnostic { code, severity, message, path?, hint? }`
   - `message` should be plain strings for now (i18n in PR-07)

6) **Tests**
   - Unit tests:
     - schema validation (positive/negative)
     - hash recomputation matches embedded schema_hash
   - Integration-ish tests using fixture resolver (may stub until PR-08):
     - create small flow IR with one node + metadata, run doctor offline, pass
     - missing metadata fails

## Files likely touched
- `src/flow_meta.rs`
- `src/flow_ir.rs`
- `src/wizard_ops.rs` (add contract decode/hash helpers)
- `src/schema_validate.rs` (new)
- `src/doctor.rs` (new)
- `src/cli.rs` / command wiring
- `Cargo.toml` (deps for hashing/cbor canonicalization if needed)

## Acceptance criteria
- `add-step` and `update-step` persist describe_hash + schema_hash + operation_id deterministically.
- Config returned by apply-answers is validated against SchemaIR; invalid config fails early.
- `greentic-flow doctor` validates flows offline and returns deterministic diagnostics.
- `cargo test` passes.

## Decisions / answers (2026-02-11)
1) describe() typed schema location + hash recomputation rules
- Typed schema location: `greentic_types::schemas::component::v0_6_0::ComponentDescribe` (expanded form with `operations[]`, inline SchemaIR, config_schema, and path-wrapped input/output).
- describe_hash: `sha256(canonical_cbor(typed_describe))` where bytes are decoded into the typed struct, then canonical CBOR re-encoded.
- schema_hash per node/op: `sha256(canonical_cbor({ input: op.input.schema, output: op.output.schema, config: describe.config_schema }))`.
- Canonicalization rule: always re-encode with canonical CBOR rules (deterministic map order via BTreeMap, stable encoding).

2) Doctor default offline vs requiring explicit --online
- Default is OFFLINE. Network re-resolve only with explicit `--online` (or `--resolve`).

3) SchemaIR constraints: mandatory vs best-effort
- Mandatory enforcement:
  - type checks
  - object required fields
  - additionalProperties behavior (deny/allow + schema)
  - enum membership
  - array item type and min/max items (if present)
  - numeric min/max (if present)
  - string min/max length (if present)
- Best-effort (warn if present but unsupported initially):
  - regex (warn unless regex crate support exists)
  - formats (email/uri/etc.) unless a formal registry exists
- If regex is present but unsupported: warn now, error later. Do not silently ignore without a diagnostic.
