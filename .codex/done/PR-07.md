# PR-07 — greentic-flow: Flow wizard + answers workflow + greentic-qa integration + i18n rendering

Repo: `greentic-flow` (plus deps on `greentic-qa`, `greentic-i18n`)

## Goal
Add a first-class **Flow Wizard** to create and edit flows using component QA specs and answers, with full i18n support:
- Multi-step guided flow creation and editing
- Answers persisted as JSON + canonical CBOR
- Interactive prompting via `greentic-qa`
- Render QA prompts using `greentic-i18n` locale resolution (keys + fallbacks)
- Resume workflow via deterministic cache state (no re-asking unless requested)

PR-06 must already provide contract persistence + SchemaIR validation.

## Scope
### In-scope
- New CLI group: `greentic-flow wizard ...`
- Answers directory conventions:
  - `answers/<flow_id>/<node_id>/<mode>.answers.json`
  - `answers/<flow_id>/<node_id>/<mode>.answers.cbor` (derived)
- Greentic-QA runner integration (library preferred, binary fallback allowed):
  - decode `ComponentQaSpec` CBOR
  - render questions
  - produce answers map
- greentic-i18n integration:
  - locale selection + fallback chain
  - resolve `I18nText` for title/labels/help/options/errors
- Wizard state persistence:
  - `.greentic/cache/flow_wizard/<flow_id>.cbor` (or sidecar) to resume
- Deterministic flow edits and `--dry-run` preview.

### Out-of-scope
- No-network fixture resolver and CI harness (PR-08)
- Distribution “search/list components” UX beyond current resolver capabilities (can be added later)
- Runtime execution runner improvements

## CLI design
### New commands
- `greentic-flow wizard new --flow <file> [--locale <bcp47>] [--interactive] [--answers-dir <dir>]`
- `greentic-flow wizard edit --flow <file> [--locale <bcp47>] [--interactive] [--answers-dir <dir>]`
- `greentic-flow wizard add-step <component_id> --flow <file> [--op <op>] [--mode default|setup] ...`
- `greentic-flow wizard update-step <target> --flow <file> [--mode upgrade] ...`
- `greentic-flow wizard remove-step <target> --flow <file> [--mode remove] ...`

### Flags
- `--answers <file-or-dir>`:
  - file = single step answers.json
  - dir = wizard workspace (multi-step)
- `--overwrite-answers` (default false)
- `--reask` forces interactive even if answers exist
- `--dry-run` prints planned changes and exits with 0 if valid
- `--non-interactive` fails if answers missing (never prompts)

## i18n behavior
- Determine locale:
  - explicit `--locale`, else env (`GREENTIC_LOCALE`), else `en`
- Fallback:
  - locale chain (e.g., `nl-NL` → `nl` → `en`)
- Resolve strings:
  - if translation exists: use it
  - else if `I18nText.fallback` exists: use fallback
  - else show key

## Answers workflow
- Always keep JSON answers (human-editable).
- Always generate canonical CBOR answers (tooling).
- Canonicalization:
  - JSON → typed map → canonical CBOR with deterministic key order.
- Store alongside wizard state so future runs are idempotent.

## Implementation tasks
1) **Wizard state model**
   - `WizardState { flow_id, locale, steps: Vec<WizardStepState>, last_updated }`
   - store under `.greentic/cache/...` or flow sidecar

2) **QA runner integration**
   - decode `ComponentQaSpec` CBOR
   - render with resolved strings (i18n)
   - collect answers into deterministic map
   - write `answers.json` and `answers.cbor`

3) **Wizard orchestration**
   - new/edit flows:
     - add multiple steps interactively
     - choose op/mode
     - call existing add/update/remove-step implementations under the hood
   - ensure deterministic node IDs and ordering

4) **Preview / dry-run**
   - compute changes without writing
   - display diff-like summary:
     - nodes added/updated/removed
     - metadata updates
     - secrets/bindings hints

5) **Tests**
   - unit tests:
     - i18n resolution (keys + fallbacks)
     - answers JSON→CBOR canonicalization
   - integration tests (fixture resolver can be stubbed until PR-08):
     - wizard run produces flow + answers artifacts deterministically
     - resume works (no re-ask)

## Files likely touched
- `src/wizard/mod.rs` (new)
- `src/wizard/state.rs` (new)
- `src/wizard/qa_runner.rs` (new)
- `src/i18n.rs` (new or extend)
- `src/cli.rs` (wire commands)
- `src/answers.rs` (new helper)
- `Cargo.toml` (deps: greentic-qa, greentic-i18n)

## Acceptance criteria
- Wizard can create/edit flows using QA specs and answers.
- Answers persisted as JSON + canonical CBOR.
- i18n resolution works with locale fallback.
- `--non-interactive` never prompts; `--dry-run` produces deterministic previews.
- `cargo test` passes.

## Decisions / answers (2026-02-11)
1) Wizard state storage
- Default: `.greentic/cache/flow_wizard/<flow_id>.cbor`.
- Rationale: keeps flow files clean and avoids VCS churn; supports resume without expanding metadata.
- Optional sidecar storage can be added later (`--state-in-sidecar`).

2) Locale default + fallback chain
- Locale selection:
  - `--locale <bcp47>` if provided
  - else `GREENTIC_LOCALE`
  - else `en`
- Fallback chain example: `nl-NL` → `nl` → `en`.
- Resolution per `I18nText`:
  - use translation for key in first available locale
  - else fallback string
  - else show key

3) Reuse existing add/update/remove implementations or separate code paths?
- Reuse existing handlers. Wizard should be thin orchestration over:
  - `handle_add_step`
  - `handle_update_step`
  - `handle_remove_step`
