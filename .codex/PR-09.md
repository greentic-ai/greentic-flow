# PR-09 — greentic-flow: UX polish + contract-change guardrails + flow-level i18n diagnostics

Repo: `greentic-flow`

## Goal
Finish the “wizard-grade” experience by adding:
- Contract change detection guardrails (describe_hash drift)
- Better error UX (actionable, stable codes)
- Flow-level i18n diagnostics and reporting
- Diff/preview improvements and safe-write semantics

This PR is where we make the CLI feel reliable and hard to misuse.

## Scope
### In-scope
1) Contract-change guardrails
- On update-step/add-step:
  - if node already has a describe_hash and the newly resolved describe_hash differs:
    - default behavior: fail with a clear diagnostic explaining contract changed
    - allow override: `--allow-contract-change`
- On flow doctor:
  - offline mode checks metadata only
  - online mode re-resolves and reports drift

2) UX polish
- `--dry-run` everywhere (add/update/remove + wizard)
- “plan summary” output:
  - nodes touched, metadata updates, secrets/bindings hints
- Safe writes:
  - write to temp file then atomic rename
  - optional `--backup` creates `.bak`

3) i18n for diagnostics
- Introduce `DiagnosticMessage` as `I18nText` (or key+fallback) for user-facing errors.
- Integrate greentic-i18n so diagnostic output can be localized.

4) Secrets/bindings readiness checks
- Add `greentic-flow validate-secrets --flow <file> --tenant <t> --env <e>` (optional)
- For now, simply ensure hints exist and are well-formed; future PR can wire to secrets store.

### Out-of-scope
- Changing SchemaIR semantics
- Changing resolver behavior

## Implementation tasks
1) **Drift check**
- Store describe_hash per node (already in PR-06)
- Add comparison logic in add/update
- Add flag `--allow-contract-change`

2) **Diagnostics overhaul**
- Standardize codes (examples):
  - `FLOW_CONTRACT_DRIFT`
  - `FLOW_SCHEMA_INVALID`
  - `FLOW_MISSING_METADATA`
  - `FLOW_I18N_KEY_MISSING`
- Ensure stable ordering and consistent formatting
- Add `--format human|json` to all relevant commands

3) **Atomic writes**
- Implement write helper:
  - serialize → temp → fsync → rename
- Ensure on Windows/Unix semantics where possible

4) **i18n diagnostics**
- Convert key messages to `I18nText`
- Provide default `en` bundle for CLI diagnostics

5) **Tests**
- Contract drift test: update-step fails unless flag set
- Dry-run does not write files
- Atomic write helper tested via temp dirs

## Acceptance criteria
- Contract drift is detected and blocks by default.
- Dry-run works consistently across commands.
- Writes are atomic and optionally backed up.
- Diagnostics can be localized and remain deterministic.
- `cargo test` passes.

## Decisions / answers (2026-02-11)
1) Default behavior on drift
- Hard fail by default. Allow override with `--allow-contract-change`.

2) Which commands need --format human|json first?
- Implement first for:
  - `doctor`
  - wizard commands (new/edit/add/update/remove)
  - add-step/update-step/remove-step (non-wizard too)

3) Diagnostics localization: global or per-command flag?
- Global flag. `--locale` controls localization and `--format` controls serialization.
- In JSON output include both:
  - `message` (resolved)
  - `message_key` + `fallback` (for UIs to re-render)
